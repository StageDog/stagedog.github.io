# 插入

{{ prolog }}

## 与预设的关系

世界书条目除了设置怎么激活, 还需要设置插入位置. 我仅建议你使用`角色定义之前`、`角色定义之后`、`D⚙️`、`D👤`、`D🤖`, 另外几个选项通常不会给你带来额外好处:

:::{figure} 可能的插入位置.png
可能的插入位置
:::

酒馆在确认需要激活的世界书条目后, 即会根据插入位置将它们插入到预设中: (预设可能给这些条目改了名字)

:::{figure} 预设对应位置.png
预设对应设置
:::

如上图所示,

- `角色定义之前`、`角色定义之后` 分别与 `World Info (before)`、`World Info (after)` 对应.
- 深度条目 (`D⚙️`、`D👤`、`D🤖`) 按照你在条目中填写的`深度`插入到聊天记录对应深度中:

  ```text
  D3
  倒数第三条消息
  D2
  倒数第二条消息（一般我们发送用户输入来请求生成，则这里一般是最后一次 AI 回复）
  D1
  最后一条消息（一般我们发送用户输入来请求生成，则这里就是最后一次用户输入）
  D0
  ```

**模型更愿意注意更顶部和更底部的提示词.** 也就是说, 条目在不同插入位置的效果很大程度上取决于预设如何排列这些位置: 预设完全可以把 "角色定义之前" 放到 "角色定义之后" 的下面, 甚至放到预设最底部!

当然这就不是我们写世界书的需要考虑的了, 一般我们可以认为预设对提示词自上而下的排列顺序是: (仅给你一个概念)

```{code-block} text
:emphasize-lines: 4,6,8
随机内容防止预设被标记
模型伪身份定义
少量自定义设定
World Info (before) - 角色定义之前
???
World Info (after) - 角色定义之后
???
Chat History - 聊天记录
思维链、字数等大多数自定义设定
底部破限
```

显然, 随着玩家游玩的楼层越来越高, `聊天记录`部分的提示词 token 数会**远多于其他部分**, 因此你可以粗略地将预设从`聊天记录`划分为上下两部分, 则:

`角色定义之前`、`角色定义之后`
: `角色定义之前`更靠近顶部, 因此效力比`角色定义之后`更强.

深度条目 (`D⚙️`、`D👤`、`D🤖`)
: 倒数第二条消息、D1、最后一条消息、D0 更靠近底部, 因此效力比之前的某楼层更强; 而 (我的推测) AI 的任务就是创作剧情, 因此放在剧情中的深度条目效力比 `角色定义之前`、`角色定义之后` 更强.

  **这并不意味着你应该滥用 D0/D1 条目**. 如果你在深度插入过多内容, 则会变成:

  ```text
  最后一条 AI 输出 (3000 token 左右)
  D1 (6000 token!!!😱)
  最后一条用户输入 (50 token 左右)
  D0 (3000 token!!!😱)
  ```

  ……AI 的注意力全被你的要求占据, 连剧情都不能连贯理解了; 此外, 想象一下, 剧情中角色性格已经发生变化, 可你将最初的角色设定放在了 D0……

  这也是为什么我非常抵制很多卡不经考虑就将世界规则、特殊输出格式、变量更新规则 (甚至可能是直接搬用别人的规则, 没有任何改动) 放在 D0/D1 条目中. \
  请考虑学习利用 AI 的 recall 机制 (见下面提示中的部分写法) 和{doc}`手写 mvu 变量卡教程 </络络/教程/手写mvu变量卡/index>`

:::{hint}
基于模型更愿意注意更顶部和更底部提示词的原理, 你可以发现:

- 一些预设会在底部设置了 "输出格式强调" 条目, 让你如果掉格式了去把掉的格式填写进去.
- Nova Lite 预设会用正则去除用户输入, 而新建一个底部条目{menuselection}`Nova⭐重申输入📌`, 其中填写酒馆宏 `{{lastUserMessage}}`. 这个酒馆宏在发送时即被替换成最后一条用户输入, 从而将用户输入置于底部.
- 戏剧之王预设在卡掉思维链的条目{menuselection}`🔒卡原生思维链part3`中会重申要求 AI 输出 `<thinking>`.
- {doc}`可点击的选择框 </青空莉/作品集/index>`在 D4 时编写了 400~700 token 左右的选择框格式和要求提示词, 但在 D0 时用 60 token 强调输出.
:::

## 条目插入到同一预设位置的顺序

假设我们有两个条目都要插入到 `D0`, 那它们谁在上面谁在下面? 此处将教你 (没必要地) 如何确定条目插入顺序.

### 消息身份

对于深度条目 (`D⚙️`、`D👤`、`D🤖`) 而言, 如果它们插入到同一深度, 则从上到下总是:

```text
D🤖: 所有 AI 条目
D👤: 所有用户条目
D⚙️: 所有系统条目
```

而`角色定义之前`和`角色定义之后`条目的身份是由预设中的 `World Info (before)` 和 `World Info (after)` 决定的, 因此不存在消息身份上的顺序区分.

### 顺序

在经过消息身份区分后, 如果两个同插入位置条目还没有决定出顺序, 则会根据{menuselection}`顺序`来区分, 顺序越大插入越靠下.

不同世界书的条目可能按顺序值混合在一起. 也就是说, **如果你有几个需要连起来的条目, 你最好挑一个随机数 (999 太常用了!) 作为顺序值来排布.**

:::{figure} 顺序.png
:::

### 如果顺序值相同

这种情况的插入顺序区分我可以写几百字, **别纠结谁先谁后了, 需要区分就把顺序值设成不同的.**
