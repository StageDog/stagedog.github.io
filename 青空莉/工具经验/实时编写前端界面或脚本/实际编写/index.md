# 实际编写

{{ prolog }}

区分了脚本和前端界面, 我们现在可以实际编写它; 如果你不知道酒馆助手提供了哪些功能, 可以查阅[酒馆助手文档](https://n0vi028.github.io/JS-Slash-Runner-Doc/).

**以下内容你都可以先用示例角色卡、`src/脚本示例` 和 `src/界面示例` 先过一遍, 别急着搓自己的东西.**
**以下内容你都可以先用示例角色卡、`src/脚本示例` 和 `src/界面示例` 先过一遍, 别急着搓自己的东西.**
**以下内容你都可以先用示例角色卡、`src/脚本示例` 和 `src/界面示例` 先过一遍, 别急着搓自己的东西.**

## 完整流程

在`初始模板`文件夹中, 我分别给出了`脚本`和`前端界面`项目所需的初始文件. 此处以编写`前端界面`为例, 而`脚本`的编写流程与之类似.

为了创建前端界面项目, 你需要将`初始模板/前端界面/新建为src文件夹中的文件夹`复制到 `src` 文件夹中, 将它重命名为你想要的名称:

:::{figure} 创建新项目.png
:::

然后我们让 Cursor 等 AI 编程助手为我们编写代码:

```text
阅读现有规则, 为我在`手机角色状态栏`中编写前端界面
它应该是一个手机风格的角色状态栏, 该手机页面应当包含边框、刘海、聊天界面等, 并显示有角色当前的状态
```

:::{warning}
需要注意的是, 我这里只是演示因此直接提出了一个完整要求, 但你在实际编写时应该尽量先和 AI 沟通好, 让 AI 一点点做, 做出来一部分就测试一部分, 而不是指望它能一次性生成完整可用的界面.
:::

编写完毕后, 我们在终端执行 `pnpm build` 来打包代码.

如果该操作执行失败, 你可以让 AI 检查错误原因并修复它. 一般直接问 AI 即可, 也可以自己在终端中选中错误信息然后 {menuselection}`Add to Chat`.

:::{figure} 打包失败.png
:::

如果该操作执行成功, 则会在 `dist` 文件夹中找到 `pnpm build` 对新项目的打包结果:

:::{figure} 打包成功.png
:::

这个打包结果是单个 html 文件 (如果是脚本则是单个 js 文件), 它包含了项目中所有文件的代码, 因此你可以将它的内容用代码块包裹 (在之前的{doc}`/青空莉/工具经验/实时编写前端界面或脚本/阅读示例/index`中有解释) 然后复制到酒馆正则中的{menuselection}`替换为`部分 (如果是脚本则将它的内容复制到酒馆助手脚本库脚本中的{menuselection}`脚本内容`部分). \
如果这个酒馆正则被应用, 酒馆助手就会自动渲染出前端界面:

:::{figure} 渲染结果.png
:::

这就是我们项目的整个流程:

1. 在 `src` 文件夹中新建项目
2. 让 AI 在这个项目中编写代码
3. 用 `pnpm build` 将项目打包成一个文件
4. 将 `dist` 文件夹中的打包结果用代码块包裹后复制到酒馆正则中 (如果是脚本则复制到酒馆助手脚本库脚本中的{menuselection}`脚本内容`部分)

但 AI 会听不懂我们的要求或犯错, 一次编写很可能无法写出我们想要的脚本或前端界面. 这又该如何是好呢? 难道我们每次让 AI 修改了代码, 都要重新 `pnpm build` 打包代码, 再手动复制粘贴到酒馆中来验证?

不, 我们更希望:

- 对脚本和前端界面的修改能实时更新到酒馆中
- AI 能自己查看酒馆网页来理解你说的要求或问题
- (有代码基础的人) 能够自行查看代码执行情况来定位错误

## 将修改实时更新到酒馆

假设我们已经从`初始模板`中创建了前端界面项目`界面示例`, 我们希望将它的最新内容实时更新到酒馆中.

回顾一下如果没有实时修改, 我们是如何修改项目并更新到酒馆中的:

- 让 AI 修改代码
- 重新 `pnpm build` 打包代码
- 将 `dist` 文件夹中的打包结果用代码块包裹后复制到酒馆正则中 (如果是脚本则复制到酒馆助手脚本库脚本中的{menuselection}`脚本内容`部分)

因此, 我们需要实现 "重新 `pnpm build` 打包代码" 和 "将打包结果用代码块包裹后复制到酒馆正则中" 的自动化.

### 项目被修改后自动打包

要做到项目被修改后自动打包, 我们不再运行 `pnpm build`, 而是运行 `pnpm watch`. watch 意为监听, 也就是说, `pnpm watch` 会监听项目中的文件变化, 并在变化时自动重新打包代码.

当然你可能不想记那么多命令, 也可以修改 `.vscode/launch.json` 中的 `url` 为自己的酒馆地址 (例如 `http://localhost:6622`), 然后通过 {kbd}`F5` 运行调试任务. 这会为我们运行 `pnpm build` 并打开酒馆网页.

:::{figure} 更改launch.png
:::

### 将打包结果实时更新到酒馆

为了让酒馆页面实时加载最新的打包结果, 我们不能是再自己手动复制打包结果到酒馆正则中, 而要让酒馆页面自动加载它. 这需要:

- 让酒馆知道打包结果发生了变化并在变化时重新加载脚本和前端界面: 我们需要将酒馆与打包监听器 `pnpm watch` 连接
- 让酒馆在重新加载时能获取到最新打包结果: 我们可以将打包结果文件映射为网络链接, 在酒馆里填写这个网络链接而不是自己每次复制粘贴, 则酒馆重新加载脚本和前端界面时会重新访问这个链接, 从而得到最新的打包结果

#### 将酒馆与打包监听器连接

酒馆助手已经为我们实现了酒馆与打包监听器 `pnpm watch` 的连接, 我们从{menuselection}`酒馆助手 --> 实时监听`中启用{menuselection}`允许监听`即可.

如果我们已经运行 `pnpm watch` 或 {kbd}`F5`, 则实时监听右边的 WiFi 图标会变成绿色, 这意味着酒馆已经能知道打包结果是否发生变化.

:::{figure} 启用实时监听.png
:::

#### 将最新打包结果以链接形式导入

我们点击 Cursor 右下角的 {menuselection}`Go Live` 来将文件夹中所有文件映射成一个网络链接:

:::{figure} 启动live_server.png
:::

在点击后, {menuselection}`Go Live` 将会变成 {menuselection}`port: xxxx`. 以 `port: 5500` 为例, 这意味着你将能在 `http://localhost:5500` 访问文件夹下的文件:

:::{figure} 访问文件.png
:::

而打包结果 `dist/界面示例/index.html` 将能以 `http://localhost:5500/dist/界面示例/index.html` 访问.

有了这个链接, 我们接下来更换酒馆正则{menuselection}`替换为`部分的 html 代码块, 让它从 `http://localhost:5500/dist/界面示例/index.html` 加载 html:

````{code-block} html
:emphasize-lines: 4
```
<body>
  <script>
    $('body').load('http://localhost:5500/dist/界面示例/index.html')
  </script>
</body>
```
````

这正是`初始模板/前端界面/导入到酒馆`中的实时修改正则所做的事情, 而`初始模板/脚本/导入到酒馆`中的实时修改脚本填法有所不同, 但你不必记忆. 你可以直接从文件夹找到并导入它们, 然后将其中的链接替换为你的打包结果链接.

## 让 AI 能看到酒馆页面

要让 AI 能看到酒馆页面, 我们使用 Browser MCP.

模板文件夹已经为很多编程助手配置了 Browser MCP (见于{doc}`/青空莉/工具经验/实时编写前端界面或脚本/环境准备/index`), 我们唯一要做的是安装它所需要的浏览器扩展.

我们按 `F5` 打开调试用浏览器后 (或自行 `pnpm watch` 然后使用你自己的浏览器), 从 [chrome 应用商店](https://chromewebstore.google.com/detail/browser-mcp-automate-your/bjfgambnhccakkhmkepdoekmckoijdlc)安装最新的浏览器扩展.

如此, 我们回到酒馆网页, 点击扩展图标然后点击 {menuselection}`连接` 即可.

:::{figure} 连接browser_mcp.png
:::

你的 AI 编程助手现在可以: (AI 不一定主动使用, 你可以在提示词中告诉它 `用 browsermcp 来访问当前网页`)

- 读取酒馆网页显示情况、控制台 (Console) 日志情况、网络情况
- 读取你通过 {menuselection}`开发者工具 --> 左上角的选择元素` 选择到的网页元素

:::{figure} mcp连接成功.png
AI 使用 MCP 时会有很明显的显示
:::

## 断点调试错误

可能太专业因而不详细解释: 这个项目模板也天然支持断点调试, 你可以在代码中设置断点, 则 {kbd}`F5` 运行时程序会自动在断点处暂停并显示运行情况.

## 最终编写流程

我们现在有了实时修改和 AI 直接看酒馆页面的功能, 则编写流程应该如下:

### 创建项目

在 `src` 文件夹中用`初始模板`新建项目.

在{menuselection}`酒馆正则`中导入`初始模板`中的实时修改正则 (编写脚本则在{menuselection}`酒馆助手 --> 脚本库`中导入实时修改脚本), 并将其中的链接替换为打包结果链接.

### 进行编写

1. 点击 Cursor 右下角的 {menuselection}`Go Live` 将文件夹映射为网络链接
2. 在终端输入 `pnpm watch` 或按 {kbd}`F5` 运行调试任务
3. 在浏览器中打开酒馆页面, 启用 Browser MCP 的连接
4. 在提示词中指出 "阅读现有规则", 让 AI 在这个项目中编写代码、修改错误

### 发布打包结果

在确认项目完成后, 关闭 {kbd}`F5` 所打开的酒馆网页, 用 `pnpm build` 将项目打包成一个文件, 将打包结果用代码块包裹后复制到酒馆正则中 (如果是脚本则复制到酒馆助手脚本库脚本中的{menuselection}`脚本内容`部分).

**注意你应该发布 `pnpm build` 的打包结果, 而不是 `pnpm watch` 的打包结果.** `pnpm watch` 打包结果的大小是 `pnpm build` 打包结果的数十倍.
