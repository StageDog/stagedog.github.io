# 阅读示例

{{ prolog }}

让我们导入{download}`示例角色卡 <../示例.png>`, 来理解脚本和前端界面的作用和区别.

导入角色卡后, 我们通过扩展设置, 可以在{menuselection}`酒馆助手 --> 脚本`和{menuselection}`正则`中分别看到该角色卡有以下角色脚本和局部正则:

:::{figure} 打开角色卡.png
:::

这分别对应了酒馆助手所支持的两类向酒馆注入代码的方式, 与模板文件夹中的 `脚本/脚本示例` 和 `界面/前端界面示例` 文件夹一一对应.

## 脚本: 在后台运行一段代码

我们首先启用 `脚本-发布给玩家`, 将会收到一条弹窗提示:

:::{figure} 启用脚本弹窗.png
:::

这反映了脚本的功能: 在启用时执行一段代码, 可能上图那样的弹窗提示, 也可能是开始监听某些事件从而在事件发生时执行某段代码……

脚本可以在启用时执行一段代码. 除了上图那样的弹窗外, 你还能看到脚本新增了两个消息楼层:

:::{figure} 脚本新增消息楼层.png
:::

脚本能执行的代码功能非常丰富. 例如, 你可以发现开启脚本时, 酒馆的插件页面新增了一项{menuselection}`脚本示例`. 如果我们勾选其中开关、关闭脚本再重新打开, 会发现开关依旧被勾选: (请继续读下去, 在{doc}`/青空莉/工具经验/实时编写前端界面或脚本/进阶技巧/index`中将会介绍这是如何做到的)

:::{figure} 脚本添加设置页.png
:::

脚本可以监听酒馆事件和酒馆助手事件. 例如, 让我们启用这个脚本, 然后通过{menuselection}`铅笔`尝试修改一下第 0 楼的内容. \
当我们点击保存时, 脚本将会监听到 "消息楼层被修改" 事件:

:::{figure} 监听消息楼层被修改事件.png
:::

脚本也可以监听自己的按钮点击事件. 例如, 我们启用脚本后会在输入框上方看见{menuselection}`晚上好`按钮, 点击它后, 脚本将会监听到 "玩家点击了晚上好按钮" 事件:

:::{figure} 监听玩家点击按钮事件.png
:::

脚本还能监听自己的开关情况. 例如, 我们关闭脚本, 脚本会监听到 "脚本被关闭" 事件:

:::{figure} 监听脚本关闭事件.png
:::

如果你点击{menuselection}`酒馆助手 --> 脚本 --> 内置库`并添加`预设防误触`脚本, 就会发现你在开启脚本时不能修改预设设置, 关闭脚本后可以修改. 这其实就是脚本在启用时执行了一段代码, 让你不能修改预设设置; 而又监听 "脚本被关闭" 事件, 在脚本关闭时执行代码重新允许你修改预设设置.

总的来说, 脚本的作用就是:

- 在开启时可以执行一段代码
- 在启用期间可以监听事件 (酒馆或酒馆助手事件、按钮点击事件、脚本被卸载), 从而在事件发生时执行代码.

如此, 你也许能理解 MVU 变量框架脚本做了什么: 启用它后, 它将监听 "接收到了新的消息楼层" 事件, 当事件发生时根据这个新楼层中的 `<UpdateVariable>` 变量更新命令来更新变量.

## 前端界面: 在前台消息楼层显示一个界面

我们关闭脚本, 启用{menuselection}`正则`中的{menuselection}`界面-发布给玩家`正则, 将会收到整整三条弹窗提示:

:::{figure} 启用界面弹窗.png
:::

为什么是三条弹窗提示? 让我们关掉这个正则, 来仔细理解一下它是怎么起作用的.

实际上, 酒馆助手支持前端界面的方式很简单: 如果消息楼层中某个代码块内存在 html 代码 (尤其是 `<body></body>` 标签), 那么酒馆助手会自动将这个 html 代码渲染成前端界面. \
例如, 如果我们在消息楼层中添加以下代码块, 它会被渲染成一个超大的红色 "你好":

:::::{tabs}

::::{tab} 源文本

代码块由以下部分组成:

- 开头单独一行 <code class="docutils literal notranslate">\`\`\`</code>
- 代码内容
- 结尾单独一行 <code class="docutils literal notranslate">\`\`\`</code>

````html
```
<body>
  <span class="text-9xl text-red-600">你好</span>
</body>
```
````

::::

::::{tab} 渲染结果
:::{figure} 渲染你好.png
:::
::::

:::::

但我们显然不想 AI 直接输出整个 html 代码块, 这既浪费 token 又容易出错. 有没有什么办法让 AI 只输出前端界面必要的剧情信息 (如角色当前穿着情况、所在位置等), 却又在酒馆页面上显示出 html 代码块从而渲染出前端界面呢? 酒馆正则的{menuselection}`仅格式显示`功能正能实现这个功能.

酒馆正则能够捕获 AI 回复和用户输入中的特定文本, 让它在某些用途下被替换为指定内容:

- {menuselection}`仅格式提示词`: 在发送给 AI 时被替换为指定内容. 例如预设的`[不发送]思维链`正则将 `<thinking>` 块替换为空字符串, 从而不让 AI 收到之前消息中的思维链内容.
- {menuselection}`仅格式显示`: 在酒馆中显示时被替换为指定内容. 例如预设的`[隐藏]思维链`正则将 `<thinking>` 块替换为空字符串, 从而不让玩家在酒馆页面中看到思维链部分.
- 两个都不勾选: 在 AI 输出接收到时或用户输入发送出去时就被**永久**替换掉

:::{figure} 酒馆正则.png
:::

`界面-发布给玩家` 正则所做的, 就是捕获 AI 回复中尽可能多的字符, 即捕获全部文本, 并将其替换为 html 代码块.

:::{figure} 界面-发布给玩家正则.png
:::

回过头来, 为什么打开`界面-发布给玩家`正则后会收到整整三条弹窗提示呢? 因为我们总共有三个消息楼层, 正则会依次捕获替换, 而酒馆助手由此渲染了三个前端界面:

:::{figure} 渲染三个前端界面.png
:::

为了进一步验证这一点, 我们点击{menuselection}`铅笔`来编辑其中一个消息楼层. 当我们点击铅笔时, 仅该消息楼层的前端界面被卸载而有了一个 `你已经卸载界面!` 提示; 当我们点击保存时, 酒馆助手又重新渲染这个前端界面而有了 `你已经成功加载界面!` 提示.

前端界面能做的不仅仅是显示而已, 你还可以和它交互而执行对应的代码. 例如, 我们点击示例中的前端界面, 将会发现这个界面变成了选择框, 而再点击将会发现自己发送了一条消息, 并且输入框右下角显示出正在生成的图标:

:::{figure} 与前端界面交互.png
:::

总的来说, 酒馆助手能将消息楼层中的 html 代码块渲染成前端界面, 并支持:

- 在前端界面加载完成时执行一段代码
- 在前端界面有效期间监听事件 (酒馆和酒馆助手事件、前端界面被互动、前端界面卸载), 从而在事件发生时执行代码

相比于脚本在后台运行、只受自己开关影响, 前端界面在页面上显示且与消息楼层高度绑定.

## 流式楼层界面

如果你经常玩带前端界面的角色卡, 可能已经意识到了一个很不舒服的点: 前端界面只有在 AI 回复完成后才能渲染, 在那之前就是一个代码块. 这使得玩家在 AI 回复完成前不能进行任何操作, 甚至可能无法阅读剧情.

这是酒馆本身设计和前端界面设计上的限制, 只要使用前端界面就没有任何办法避免. **……那不用前端界面不就好了!**

回顾一下, 脚本的作用是:

- 在开启时可以执行一段代码
- 在启用期间可以监听事件 (酒馆或酒馆助手事件、按钮点击事件、脚本被卸载), 从而在事件发生时执行代码.

但脚本 "执行代码" 能做的事情比你想象得要多得多: 你可以直接修改整个酒馆的显示, 调整发送给 AI 的提示词……

既然脚本的 "执行代码" 能修改整个酒馆的显示, 我们完全可以将酒馆原本的楼层隐藏掉, 把我们自己的界面显示上去——**本编写模板已经直接支持这么制作流式楼层界面!**

说了这么多, 让我们继续使用示例角色卡, 关闭{menuselection}`脚本-发布给玩家`脚本和{menuselection}`界面-发布给玩家`正则, 打开{menuselection}`流式楼层界面-发布给玩家`脚本体验一下:

:::{figure} 流式楼层界面.png
:::

可以看到, 三个楼层已经发生了变化: 在消息最上方出现一个高亮框, 而每段文本被遮挡了需要 "点击查看".

当然, 这毕竟是流式楼层界面, 只是显示过去的 AI 回复怎么行呢! 让我们发送一条消息试试:

:::{video} 与流式楼层界面交互.mp4
:align: center
:::

在 AI 还在流式回复的途中, 我们已经能看到界面渲染结果, 还能和它交互了!

你当然可以更进一步, 如{doc}`日记络络 </络络/作品集/index>`一样制作一个流式的 Galgame 界面:

:::{video} ../进阶技巧/流式界面.mp4
:align: center
:caption: 日记络络中的流式 Galgame 界面
:::
