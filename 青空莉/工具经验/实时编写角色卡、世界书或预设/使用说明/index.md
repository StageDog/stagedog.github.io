# 使用说明

{{ prolog }}

## 初次运行

我们现在下载和安装了脚本, 接下来就能使用它了.

假设我们在 Cursor 中打开了一个文件夹用于存放本地文件, 并拖入了这个脚本, 则应该显示为这样的界面:

:::{figure} 打开文件夹.png
:::

如果你没有显示{menuselection}`终端`, 可以通过 {kbd}`Ctrl-Shift-P` 打开命令菜单, 输入 `toggle terminal` 以找到{menuselection}`查看: 切换 终端`, {kbd}`回车`从而打开{menuselection}`终端`.

我们在终端尝试运行一下这个脚本. 具体地, 我们输入以下命令然后{kbd}`回车`:

```bash
node tavern_sync.mjs
```

如果一切顺利, 你应该会看到这样的输出:

```bash
配置文件不存在，已自动生成在 '你打开的文件夹/tavern_sync.yaml'，请填写配置文件后重新运行
```

而侧边栏也将显示 `tavern_sync.yaml` 文件, 点击即可编辑:

:::{figure} 生成配置文件.png
:::

## 配置并提取世界书或预设

我已在生成的配置文件中提供了一个示例配置, 你可以根据它来配置你的世界书和预设. 例如, 如果你想将猴子打字机预设映射到本地文件, 则可以填写为:

```yaml
配置:
  猴子打字机: # 配置名称
    类型: 预设
    酒馆中的名称: 【猴子打字机】v1.7 # 酒馆中的预设名称
    本地文件路径: 猴子打字机        # 将配置映射为 `猴子打字机.yaml` 文件
```

然后我们就能提取它:

```bash
node tavern_sync.mjs pull 猴子打字机
```

执行命令后, 侧边栏将会多出一个配置文件和文件夹:

- `猴子打字机.yaml` 配置文件中是预设的设置 (如上下文长度、是否流式传输等) 和提示词条目列表
- `猴子打字机`文件夹中则是各条目的提示词内容, 每个都是独立的文件

:::{figure} 提取预设.png
:::

## 修改世界书或预设

现在, 你就已经可以通过修改本地文件来修改`猴子打字机`预设了.

`提示词`中每个 `-` 块即对应一个预设条目, 而整个`提示词`直接反映预设在酒馆中的显示结果 (世界书则对应于酒馆世界书编辑器切换为{menuselection}`自定义`排序后的显示结果), 因此你可以非常简单地进行条目的新建、删除、修改、排序.

例如, 我想要修改`猴子打字机`两个条目的顺序, 则可以直接交换两个条目在提示词条目列表中的顺序:

:::{figure} 交换条目顺序.png
:::

- 想要调整条目顺序? 直接将它对应的 `-` 块移动到想要的位置.
- 想要修改条目? 直接调整对应 `-` 块和文件中的内容.
- 想要删除条目? 直接删掉它在`提示词`中对应的那一块 `-`.
- 想要新建条目? 复制粘贴一块 `-`, 填入新条目对应的设置和 `文件: 文件路径`, 然后在对应的文件路径下新建一个文件存放提示词. (你也可以不新建文件直接在这里写提示词, 在之后的{doc}`/青空莉/工具经验/实时编写角色卡、世界书或预设/特殊功能/index`会解释怎么做到.)

## 同步修改结果到酒馆

在完成修改后, 我们将修改结果同步到酒馆:

```bash
node tavern_sync.mjs push 猴子打字机 -f
```

## 实时修改

如果你想长时间更改, 又需要频繁地在酒馆测试更改后结果, 则可以开启监听功能. \
在监听过程中, **你只需要修改本地文件, 酒馆就会自动同步你的修改**:

```bash
node tavern_sync.mjs watch 猴子打字机 -f
```

## 直接打包文件

此外, 你也可以直接打包可以由酒馆导入的文件:

```bash
# 将世界书/预设推送到酒馆网页, 并从酒馆网页打包文件回本地
node tavern_sync.mjs push --export 猴子打字机
```

```bash
# 不经过酒馆网页直接打包文件, 因此你甚至不需要开启酒馆网页
node tavern_sync.mjs bundle 猴子打字机
```

打包文件默认会存放在与 `本地文件路径` 同目录下; 如果你想要存放在其他地方或更改打包文件名称, 可以在配置文件中添加 `导出文件路径` 配置:

```{code-block} yaml
:emphasize-lines: 6
配置:
  猴子打字机:
    类型: 预设
    酒馆中的名称: 【猴子打字机】v1.7
    本地文件路径: 猴子打字机
    导出文件路径: 导出/猴子打字机
```

## 获取命令帮助

以上就是本同步脚本的基本用法. 你可以用 `node tavern_sync.mjs -h` 来获取更多帮助, 用 `node tavern_sync.mjs 具体命令 -h` 来获取具体命令的帮助.

## 更新脚本

本脚本的酒馆助手脚本部分会自动更新, 本地脚本部分你可以用 `node tavern_sync.mjs update` 来更新.

## 在编写模板中使用同步脚本

如果你需要编写大型角色卡, **我非常非常推荐你使用我的编写模板**. 一开始可能会很不适应, 但习惯后, 它将允许你更统一地自行或让 AI 编写变量角色卡、前端界面或脚本. 请阅读{doc}`/青空莉/工具经验/实时编写前端界面或脚本/环境准备/index`来配置它, 模板的使用说明也在其中.

配置好后, 你会发现文件夹内已经有了同步脚本 `tavern_sync.mjs` 和配置文件 `tavern_sync.yaml`, 并且在 `src` 文件夹内也有 `角色卡示例` 文件夹, 其内存放了这个角色卡的第一条消息、脚本、界面、世界书等内容:

- 第一条消息: 目前还不支持实时修改, 但你可以存到这个文件夹里统一管理
- 脚本: 编写模板支持运行 `pnpm watch` 来实时修改脚本
- 界面: 编写模板支持运行 `pnpm watch` 来实时修改界面
- 世界书: 编写模板文件夹内已经有了 `tavern_sync.mjs` 和 `tavern_sync.yaml`, 你只需要调整 `tavern_sync.yaml` 即可像上文演示的那样用 `node tavern_sync.mjs 命令` 来同步世界书……而为了让你更方便, 编写模板在 `pnpm watch` 时会自动运行 `node tavern_sync.mjs watch 所有 -f` 来允许你实时修改世界书!

——也就是说, 在这个编写模板里, 你只需要运行 `pnpm watch` 这一个命令即可启用实时修改!
